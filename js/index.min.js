function loadSettings(){""!=localStorage.serial&&($("#serial").val(localStorage.serial),$("#name").val(localStorage.name),$("#upn").val(localStorage.upn))}function saveSettings(){localStorage.serial=$("#serial").val(),localStorage.name=$("#name").val(),localStorage.upn=$("#upn").val()}$(document).ready(function(){loadSettings()}),$(window).on("unload",function(){saveSettings(),loadSettings()});var base32_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";function inputHex(){var e=prompt("Please enter the seed in hex format. String of HEX type must be in byte increments ","");null!=e&&$("#secret").val(hex2base32(e))}function hex2base32(e){for(var t=[],a=0;a<e.length/2;a++){var n=e.substr(2*a,2);t[a]=parseInt(n,16)}return binary_to_base32(t)}function binary_to_base32(e){for(var t=[],a=0,n=e.length;e.length%5;)e[e.length]=0;for(a=0;a<e.length;a+=5){if(t+=base32_chars.charAt(e[a]>>3),t+=base32_chars.charAt((7&e[a])<<2|(192&e[a+1])>>6),a+1>=n){t+="======";break}if(t+=base32_chars.charAt((62&e[a+1])>>1),t+=base32_chars.charAt((1&e[a+1])<<4|(240&e[a+2])>>4),a+2>=n){t+="====";break}if(t+=base32_chars.charAt((15&e[a+2])<<1|(128&e[a+3])>>7),a+3>=n){t+="===";break}if(t+=base32_chars.charAt((124&e[a+3])>>2),t+=base32_chars.charAt((3&e[a+3])<<3|(224&e[a+4])>>5),a+4>=n){t+="=";break}t+=base32_chars.charAt(31&e[a+4])}return t}function download(){var e=document.getElementById("AzureCSV").value;e=e.replace(/\n/g,"\r\n");var t=new Blob([e],{type:"text/plain"}),a=document.createElement("a");return a.download="MFA-tokens.csv",a.href=window.URL.createObjectURL(t),a.target="_blank",a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),!1}function dec2hex(e){return(e<15.5?"0":"")+Math.round(e).toString(16)}function hex2dec(e){return parseInt(e,16)}function base32tohex(e){for(var t="",a="",n=0;n<e.length;n++)t+=leftpad("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(e.charAt(n).toUpperCase()).toString(2),5,"0");for(var n=0;n+4<=t.length;n+=4)a+=parseInt(t.substr(n,4),2).toString(16);return a}function leftpad(e,t,a){return t+1>=e.length&&(e=Array(t+1-e.length).join(a)+e),e}function randombase32(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",a=0;a<32;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function updateOtp(){var e=base32tohex($("#secret").val()),t=leftpad(dec2hex(Math.floor(Math.round(new Date().getTime()/1e3)/30)),16,"0"),a=new jsSHA("SHA-1","HEX");a.setHMACKey(e,"HEX"),a.update(t);var n=a.getHMAC("HEX");if($("#QR").html(""),$("#QR").qrcode({text:"otpauth://totp/user@host.com?secret="+$("#secret").val(),size:300}),$("#secretHex").text(e),$("#secretHexLength").text(4*e.length+" bits"),$("#epoch").text(t),$("#hmac").empty(),"KEY MUST BE IN BYTE INCREMENTS"==n)$("#hmac").append($("<span/>").addClass("label important").append(n));else{var r=hex2dec(n.substring(n.length-1)),s=n.substr(0,2*r),l=n.substr(2*r,8),d=n.substr(2*r+8,n.length-r);s.length>0&&$("#hmac").append($("<span/>").addClass("label label-default").append(s)),$("#hmac").append($("<span/>").addClass("label label-primary").append(l)),d.length>0&&$("#hmac").append($("<span/>").addClass("label label-default").append(d))}var p=(hex2dec(n.substr(2*r,8))&hex2dec("7fffffff"))+"";p=p.substr(p.length-6,6),$("#otp").html("&nbsp;"+p+"&nbsp;");var c='<table  class="table table-striped table-sm  table-bordered" style="width:100%">';c+="<tr><td><b>Skew</b></td><td><b>OTP</b></td></tr>";var u=0;for(u=-(30*$("#skew").val());u<=30*$("#skew").val();u+=30)c=0==u?c+"<tr><td><b>"+u+" sec.</b></td><td><b>&#9205;"+updateOtp2(u)+"&#9204;</b></td></tr>":c+"<tr><td>"+u+" sec.</td><td>"+updateOtp2(u)+"</td></tr>";c+="</table>",$("#otp2").html(c)}function updateOtp2(e){var t=base32tohex($("#secret").val()),a=leftpad(dec2hex(Math.floor((Math.round(new Date().getTime()/1e3)+e)/30)),16,"0"),n=new jsSHA("SHA-1","HEX");n.setHMACKey(t,"HEX"),n.update(a);var r=n.getHMAC("HEX");if($("#secretHex").text(t),$("#secretHexLength").text(4*t.length+" bits"),$("#hmac").empty(),"KEY MUST BE IN BYTE INCREMENTS"==r)$("#hmac").append($("<span/>").addClass("label important").append(r));else{var s=hex2dec(r.substring(r.length-1)),l=r.substr(0,2*s),d=r.substr(2*s,8),p=r.substr(2*s+8,r.length-s);l.length>0&&$("#hmac").append($("<span/>").addClass("label label-default").append(l)),$("#hmac").append($("<span/>").addClass("label label-primary").append(d)),p.length>0&&$("#hmac").append($("<span/>").addClass("label label-default").append(p))}var c=(hex2dec(r.substr(2*s,8))&hex2dec("7fffffff"))+"";return c.substr(c.length-6,6)}function timer(){var e=Math.round(new Date().getTime()/1e3),t=30-e%30;e%30==0&&updateOtp(),sSec=t<10?"0"+t:t,$("#updatingIn").text(sSec)}function addCSV(){document.frmConvert.AzureCSV.value=document.frmConvert.AzureCSV.value+"\n"+document.frmConvert.upn.value+","+document.frmConvert.serial.value+","+document.frmConvert.secret.value+",30,"+document.frmConvert.name.value}""==$("#secret").val()&&$("#secret").val(randombase32()),$(function(){updateOtp(),$("#update").click(function(e){updateOtp(),e.preventDefault()}),$("#secret").keyup(function(){updateOtp()}),setInterval(timer,1e3)});